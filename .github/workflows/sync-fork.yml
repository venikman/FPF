name: Sync fork with upstream

on:
  # Allow manual runs and scheduled checks to pick up upstream changes.
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"
  # Optional hook if the upstream repo sends a repository_dispatch event.
  repository_dispatch:
    types: [upstream_update]

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Determine upstream source
        run: |
          upstream=$(jq -r '.repository.parent.full_name // .repository.full_name' "$GITHUB_EVENT_PATH")
          upstream_branch=$(jq -r '.repository.parent.default_branch // .repository.default_branch // \"main\"' "$GITHUB_EVENT_PATH")
          echo "UPSTREAM_REPO=$upstream" >> "$GITHUB_ENV"
          echo "UPSTREAM_BRANCH=$upstream_branch" >> "$GITHUB_ENV"

      - name: Sync fork into fork branch
        uses: repo-sync/github-sync@v3.0.0
        with:
          source_repo: ${{ env.UPSTREAM_REPO }}
          source_branch: ${{ env.UPSTREAM_BRANCH }}
          destination_repo: ${{ github.repository }}
          destination_branch: fork
          github_token: ${{ secrets.GITHUB_TOKEN }}
